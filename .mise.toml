# .mise.toml

[tools]
# Define the Go version for the project
go = "1.25.0"
# Define node and cobra-cli for the project, as cobra-cli is an npm package
nodejs = "25.6.1"
pnpm = "10.11.0"
# idb_companion is required for --serve mode (install via: brew install facebook/fb/idb-companion)
# Protocol Buffers compiler and Go plugins
protoc = "33.4"
"go:google.golang.org/protobuf/cmd/protoc-gen-go" = "v1.36.11"
"go:google.golang.org/grpc/cmd/protoc-gen-go-grpc" = "v1.6.1"
"go:golang.org/x/tools/cmd/deadcode" = "latest"
golangci-lint = "2.10"

[env]
GO_MODULE = "github.com/k-kohey/axe"
SWIFT_PARSER = "cmd/internal/preview/swift-parser"

[tasks]
# Build the application
# Usage: mise run build
build = { depends = ["proto"], run = "go build -C cmd -o ../.output/axe ./axe" }

# Format the source code
# Usage: mise run fmt
fmt = { run = """
go fmt -C cmd ./...
xcrun swift-format format --in-place --recursive $SWIFT_PARSER/Sources $SWIFT_PARSER/Tests
""" }

# Tidy up dependencies
# Usage: mise run tidy
tidy = { run = "go mod tidy -C cmd" }

# Add a new cobra command
# Usage: mise run add-command -- <command-name>
# Example: mise run add-command -- new-cmd
add-command = { run = "cd cmd && cobra-cli add" }

# Clean the binary
# Usage: mise run clean
clean = { run = "go clean -C cmd && rm -f .output/axe" }

# Run the application with given arguments after building
# Usage: mise run exec -- <subcommand> [args...]
# Example: mise run exec -- view --frontmost
exec = { depends = ["build"], run = "./.output/axe -v" }

# Default task when running `mise run`
default = { depends = ["build"] }

# --- Composite Tasks ---
# Run all tests: mise run test
# Run individually: mise run test:go, test:swift, test:vscode
[tasks.test]
depends = ["test:swift", "test:go", "test:vscode"]

# Run all checks: mise run check
# Run individually: mise run check:fmt, check:lint, check:deadcode
[tasks.check]
depends = ["tidy", "check:fmt", "check:lint", "check:deadcode", "check:biome"]
