# .mise.toml

[tools]
# Define the Go version for the project
go = "1.25.0"
# Define node and cobra-cli for the project, as cobra-cli is an npm package
nodejs = "25.6.1"
pnpm = "10.11.0"
# idb_companion is required for --serve mode (install via: brew install facebook/fb/idb-companion)
# Protocol Buffers compiler and Go plugins
protoc = "33.4"
"go:google.golang.org/protobuf/cmd/protoc-gen-go" = "v1.36.11"
"go:google.golang.org/grpc/cmd/protoc-gen-go-grpc" = "v1.6.1"
"go:golang.org/x/tools/cmd/deadcode" = "latest"
golangci-lint = "latest"

[tasks]
# Build the application
# Usage: mise run build
build = { depends = ["proto"], run = "go build -o .output/axe ./axe-cli" }

# Format the source code
# Usage: mise run fmt
fmt = { run = """
go fmt ./...
xcrun swift-format format --in-place --recursive internal/preview/swift-parser/Sources internal/preview/swift-parser/Tests
""" }

# Tidy up dependencies
# Usage: mise run tidy
tidy = { run = "go mod tidy" }

# Add a new cobra command
# Usage: mise run add-command -- <command-name>
# Example: mise run add-command -- new-cmd
add-command = { run = "cobra-cli add" }

# Clean the binary
# Usage: mise run clean
clean = { run = "go clean && rm -f .output/axe" }

# Run the application with given arguments after building
# Usage: mise run exec -- <subcommand> [args...]
# Example: mise run exec -- view --frontmost
exec = { depends = ["build"], run = "./.output/axe -v" }

# Default task when running `mise run`
default = { depends = ["build"] }

# --- Proto Generation ---
[tasks.proto]
description = "Fetch idb proto from GitHub and generate Go code"
sources = ["internal/idb/proto/idb.proto"]
outputs = ["internal/idb/idbproto/idb.pb.go", "internal/idb/idbproto/idb_grpc.pb.go"]
run = """
mkdir -p internal/idb/proto
IDB_PROTO_URL="https://raw.githubusercontent.com/facebook/idb/e10a90af5372dbcd404eb2fbc38fa3c88630fbd7/proto/idb.proto"
curl -fsSL "$IDB_PROTO_URL" -o internal/idb/proto/idb.proto
# Inject go_package option for our module
sed -i '' '/^package idb;/a\\
option go_package = "github.com/k-kohey/axe/internal/idb/idbproto";
' internal/idb/proto/idb.proto
protoc \
  --go_out=. --go_opt=module=github.com/k-kohey/axe \
  --go-grpc_out=. --go-grpc_opt=module=github.com/k-kohey/axe \
  --proto_path=internal/idb/proto \
  internal/idb/proto/*.proto
"""

# --- Release Tasks ---
[tasks.release]
description = "Build release artifacts (Go binaries + VSIX)"
depends = ["proto"]
run = """
mkdir -p .output
GOOS=darwin GOARCH=arm64 go build -o .output/axe-darwin-arm64 ./axe-cli
GOOS=darwin GOARCH=amd64 go build -o .output/axe-darwin-amd64 ./axe-cli
cd vscode-extension && pnpm install && pnpm run compile && npx vsce package -o ../.output/
"""

# --- Check Tasks ---
[tasks.check]
description = "Run fmt, vet, and deadcode detection"
depends = ["proto"]
run = """
gofmt -w .
xcrun swift-format format --in-place --recursive internal/preview/swift-parser/Sources internal/preview/swift-parser/Tests
xcrun swift-format lint --recursive internal/preview/swift-parser/Sources internal/preview/swift-parser/Tests
go vet ./...
golangci-lint run ./...
deadcode -test ./... 2>&1 | { output=$(cat); [ -z "$output" ] && echo "deadcode: no unreachable functions found" || { echo "$output"; exit 1; }; }
"""

# --- Test Tasks ---
[tasks.test]
description = "Run all tests (Go + Swift + VSCode extension)"
depends = ["proto"]
run = """
swift test --package-path internal/preview/swift-parser
go test ./... -cover
cd vscode-extension && pnpm install && pnpm run compile && pnpm test
"""
